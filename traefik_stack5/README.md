## Introduction

This docker stack will run many services (Traefik (with Authentification), Socat, Portainer, Nginx, Caddy, Whoami) in one simple copy-paste command. Please also refer the the [README](https://github.com/pascalandy/docker-stack-this/blob/master/README.md) at the root of this repo.

## Start here
1. Go to http://labs.play-with-docker.com/ 
2. Create *one instance*. Wait for the node to provision
3. Copy-paste:

## Stable setup (recommanded)

```
echo "CONFIGURE ENV_VAR" && \
ENV_STABLE_BRANCH="master";
ENV_MONOREPO="traefik_stack5";

echo "Setup the stack" && \
source <(curl -s https://raw.githubusercontent.com/pascalandy/docker-stack-this/master/play-with-docker-setup.sh) && \
sleep 2 && \

git checkout "$ENV_STABLE_BRANCH" && \
cd "$ENV_MONOREPO" && \

./runup.sh;
```

#### Edge setup (NOT recommanded)

```
echo "CONFIGURE ENV_VAR" && \
ENV_EDGE_BRANCH="1.55";
ENV_MONOREPO="traefik_stack5";

echo "Setup the stack" && \
source <(curl -s https://raw.githubusercontent.com/pascalandy/docker-stack-this/master/play-with-docker-setup.sh) && \
sleep 2 && \

git checkout "$ENV_EDGE_BRANCH" && \
cd "$ENV_MONOREPO" && \

./runup.sh;
```

This will run `play-with-docker-setup.sh` and `runup.sh`. These scripts will do the hard of deploying the stacks for us.


#### See your stacks

```
$ docker stack ls

NAME                SERVICES            ORCHESTRATOR
toolgui             2                   Swarm
toolproxy           2                   Swarm
toolwebapp          4                   Swarm
```


#### See your services

```
docker service ls

ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS
ckqzv21zr7ox        toolgui_agent       global              1/1                 portainer/agent:latest
pop0b3w13byv        toolgui_portainer   replicated          1/1                 portainer/portainer:latest
q7sj4lhtvozp        toolproxy_socat     replicated          1/1                 devmtl/socatproxy:1.1
lb3ztruy38lp        toolproxy_traefik   replicated          1/1                 traefik:1.7.6-alpine             *:80->80/tcp, *:443->443/tcp, *:8080->8080/tcp
dl1mxwuwq1v5        toolwebapp_home     replicated          2/2                 abiosoft/caddy:0.11.1-no-stats
72th62aghchk        toolwebapp_who1     replicated          2/2                 nginx:1.15-alpine
ajdrevkyolv1        toolwebapp_who2     replicated          2/2                 emilevauge/whoami:latest
x3nop1l52lok        toolwebapp_who3     replicated          2/2                 emilevauge/whoami:latest
```

## Confirm that your services (containers) are running

1. When you see that all services are deployed, click on `80` to see the static landing page.
2. From the same URL generated by play-with-docker, in the address bar of your browser, add `/who1/` or `/who2/` or `/who3/` or `/portainer/` to access other services.


#### Full URL example

```
http://pwd10-0-7-3-80.host1.labs.play-with-docker.com/
http://pwd10-0-7-3-80.host1.labs.play-with-docker.com/who1/
http://pwd10-0-7-3-80.host1.labs.play-with-docker.com/who2/
http://pwd10-0-7-3-80.host1.labs.play-with-docker.com/who3/
http://pwd10-0-7-3-80.host1.labs.play-with-docker.com/portainer/
```

The container for the first URL is actually named `home`.


#### Web apps details:
- **/** = [caddy](https://github.com/pascalandy/caddy-securityheader)
- **/who1/** = [caddy](https://github.com/pascalandy/caddy-securityheader)
- **/who2/** = [whoami](https://hub.docker.com/r/emilevauge/whoami/)
- **/portainer/** = [portainer](https://hub.docker.com/r/portainer/portainer/)


## How to acces Traefik

![traefik](https://user-images.githubusercontent.com/6694151/50121682-86334d80-0227-11e9-8f25-93dd8714d306.jpg)


#### Traefik password

**user**: admin / **pass**: changethispass

This password is encrypted in our configs `.configs/traefik.toml`

To quickly generate yours with htpasswd, use my container:

```
docker run --rm -it devmtl/alpinefire:3.8-D sh -c 'htpasswd -Bbn admin changethispass'  
``` 

This will display:

``` 
admin:$2y$05$pAfipn3.brdHMI2eWGnYH.84XYqLozp1sUPi36/l54UAwv.zGLtNC
```

Insert this string in your `.configs/traefik.toml`.

#### What is Traefik?

[Traefik](https://docs.traefik.io/configuration/backends/docker/) is a powerful layer 7 reverse proxy. Once running, the proxy will give you access to many web apps. I think this is a solid use cases to understand how this reverse-proxy works.

#### Traefik version 

In `toolproxy.yml` look for something like `traefik:1.7.6`.

In some mono-repo I **my own traefik image**. Feel free to use the official images. It will not break anything.

#### Other stuff to know?

- This stack does not use ACME (https://). ACME is a pain while developping … reaching limits, etc.
- If you don’t want to use socat, checkout the monorepo `traefik-manager-noacme`

## Screenshots

![docker-stack-this-stack5_11](https://user-images.githubusercontent.com/6694151/34073735-76c60ae2-e26e-11e7-85a1-755a7177b3f2.jpg)
![docker-stack-this-stack5_12](https://user-images.githubusercontent.com/6694151/34073736-76d461c8-e26e-11e7-9aea-c8dbc049a383.jpg)
![docker-stack-this-stack5_13](https://user-images.githubusercontent.com/6694151/34073737-76e1d998-e26e-11e7-8b7c-c619e91adadd.jpg)
![docker-stack-this-stack5_14](https://user-images.githubusercontent.com/6694151/34073738-76f163ae-e26e-11e7-86d7-27ea62ae3284.jpg)
![docker-stack-this-stack5_15](https://user-images.githubusercontent.com/6694151/34073739-77006d4a-e26e-11e7-8f2e-cbd4268ea403.jpg)
![docker-stack-this-stack5_16](https://user-images.githubusercontent.com/6694151/49540846-158f4700-f89f-11e8-8e14-ceca2ff2b910.jpg)

![docker-stack-this-stack5_17](https://user-images.githubusercontent.com/6694151/49540848-1922ce00-f89f-11e8-9fdc-b6fce70825c8.jpg)

## All commands
In the active path, just execute those bash-scripts:

- `./runup.sh`
- `./rundown.sh`
- `./runctop.sh`

**Bonus!** `./runctop.sh` is not a stack but a simple docker run to see the memory consumed by each containers.

## ToDo
 
- Use SSL endpoints (ACME)

## Contributing

Thanks to the power of communities, this is where `1 + 1 = 3`.

1. Fork it
2. Create your feature branch: `git checkout -b my-new-feature`
3. Commit your changes: `git commit -am 'Add some feature'`
4. Push to the branch: `git push origin my-new-feature`
5. Submit a pull request


## License & Sources

- View the **GNU** license information at https://github.com/pascalandy/GNU-GENERAL-PUBLIC-LICENSE
- This Git repo is available at https://github.com/pascalandy/docker-stack-this

## Keep in touch

```
 ____                     _      _              _
|  _ \ __ _ ___  ___ __ _| |    / \   _ __   __| |_   _
| |_) / _` / __|/ __/ _` | |   / _ \ | '_ \ / _` | | | |
|  __/ (_| \__ \ (_| (_| | |  / ___ \| | | | (_| | |_| |
|_|   \__,_|___/\___\__,_|_| /_/   \_\_| |_|\__,_|\__, |
                                                  |___/
```

- Pascal Andy’s [« now page »](https://pascalandy.com/blog/now/)
- Follow me on [Twitter](https://twitter.com/askpascalandy)
- Find more Ghost Themes on [play-with-ghost.com](https://play-with-ghost.com/)